!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).bmap={},t.echarts)}(this,(function(t,e){"use strict";function o(t,e){this._bmap=t,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=e,this._projection=new BMap.MercatorProjection}function n(t,o){return o=o||[0,0],e.util.map([0,1],(function(e){var n=o[e],i=t[e]/2,a=[],r=[];return a[e]=n-i,r[e]=n+i,a[1-e]=r[1-e]=o[1-e],Math.abs(this.dataToPoint(a)[e]-this.dataToPoint(r)[e])}),this)}var i;function a(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}o.prototype.type="bmap",o.prototype.dimensions=["lng","lat"],o.prototype.setZoom=function(t){this._zoom=t},o.prototype.setCenter=function(t){this._center=this._projection.lngLatToPoint(new BMap.Point(t[0],t[1]))},o.prototype.setMapOffset=function(t){this._mapOffset=t},o.prototype.getBMap=function(){return this._bmap},o.prototype.dataToPoint=function(t){var e=new BMap.Point(t[0],t[1]),o=this._bmap.pointToOverlayPixel(e),n=this._mapOffset;return[o.x-n[0],o.y-n[1]]},o.prototype.pointToData=function(t){var e=this._mapOffset;return[(t=this._bmap.overlayPixelToPoint({x:t[0]+e[0],y:t[1]+e[1]})).lng,t.lat]},o.prototype.getViewRect=function(){var t=this._api;return new e.graphic.BoundingRect(0,0,t.getWidth(),t.getHeight())},o.prototype.getRoamTransform=function(){return e.matrix.create()},o.prototype.prepareCustoms=function(){var t=this.getViewRect();return{coordSys:{type:"bmap",x:t.x,y:t.y,width:t.width,height:t.height},api:{coord:e.util.bind(this.dataToPoint,this),size:e.util.bind(n,this)}}},o.prototype.convertToPixel=function(t,e,o){return this.dataToPoint(o)},o.prototype.convertFromPixel=function(t,e,o){return this.pointToData(o)},o.dimensions=o.prototype.dimensions,o.create=function(t,n){var a,r=n.getDom();return t.eachComponent("bmap",(function(t){var p,s=n.getZr().painter,m=s.getViewportRoot();if("undefined"==typeof BMap)throw new Error("BMap api is not loaded");if(i=i||function(){function t(t){this._root=t}return t.prototype=new BMap.Overlay,t.prototype.initialize=function(t){return t.getPanes().labelPane.appendChild(this._root),this._root},t.prototype.draw=function(){},t}(),a)throw new Error("Only one bmap component can exist");if(!t.__bmap){var l=r.querySelector(".ec-extension-bmap");l&&(m.style.left="0px",m.style.top="0px",r.removeChild(l)),(l=document.createElement("div")).className="ec-extension-bmap",l.style.cssText="position:absolute;width:100%;height:100%",r.appendChild(l);var d=t.get("mapOptions");d&&delete(d=e.util.clone(d)).mapType,p=t.__bmap=new BMap.Map(l,d);var c=new i(m);p.addOverlay(c),s.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}}p=t.__bmap;var f=t.get("center"),u=t.get("zoom");if(f&&u){var h=p.getCenter(),y=p.getZoom();if(t.centerOrZoomChanged([h.lng,h.lat],y)){var g=new BMap.Point(f[0],f[1]);p.centerAndZoom(g,u)}}(a=new o(p,n)).setMapOffset(t.__mapOffset||[0,0]),a.setZoom(u),a.setCenter(f),t.coordinateSystem=a})),t.eachSeries((function(t){"bmap"===t.get("coordinateSystem")&&(t.coordinateSystem=a)})),a&&[a]},e.extendComponentModel({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(t,e){this.option.center=t,this.option.zoom=e},centerOrZoomChanged:function(t,e){var o,n,i=this.option;return o=t,n=i.center,!(o&&n&&o[0]===n[0]&&o[1]===n[1]&&e===i.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},mapStyleV2:{},mapOptions:{},roam:!1}}),e.extendComponentView({type:"bmap",render:function(t,o,n){var i=!0,r=t.getBMap(),p=n.getZr().painter.getViewportRoot(),s=t.coordinateSystem,m=function(e,o){if(!i){var a=p.parentNode.parentNode.parentNode,r=[-parseInt(a.style.left,10)||0,-parseInt(a.style.top,10)||0],m=p.style,l=r[0]+"px",d=r[1]+"px";m.left!==l&&(m.left=l),m.top!==d&&(m.top=d),s.setMapOffset(r),t.__mapOffset=r,n.dispatchAction({type:"bmapRoam",animation:{duration:0}})}};function l(){i||n.dispatchAction({type:"bmapRoam",animation:{duration:0}})}r.removeEventListener("moving",this._oldMoveHandler),r.removeEventListener("moveend",this._oldMoveHandler),r.removeEventListener("zoomend",this._oldZoomEndHandler),r.addEventListener("moving",m),r.addEventListener("moveend",m),r.addEventListener("zoomend",l),this._oldMoveHandler=m,this._oldZoomEndHandler=l;var d=t.get("roam");d&&"scale"!==d?r.enableDragging():r.disableDragging(),d&&"move"!==d?(r.enableScrollWheelZoom(),r.enableDoubleClickZoom(),r.enablePinchToZoom()):(r.disableScrollWheelZoom(),r.disableDoubleClickZoom(),r.disablePinchToZoom());var c=t.__mapStyle,f=t.get("mapStyle")||{},u=JSON.stringify(f);JSON.stringify(c)!==u&&(a(f)||r.setMapStyle(e.util.clone(f)),t.__mapStyle=JSON.parse(u));var h=t.__mapStyle2,y=t.get("mapStyleV2")||{},g=JSON.stringify(y);JSON.stringify(h)!==g&&(a(y)||r.setMapStyleV2(e.util.clone(y)),t.__mapStyle2=JSON.parse(g)),i=!1}}),e.registerCoordinateSystem("bmap",o),e.registerAction({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},(function(t,e){e.eachComponent("bmap",(function(t){var e=t.getBMap(),o=e.getCenter();t.setCenterAndZoom([o.lng,o.lat],e.getZoom())}))})),t.version="1.0.0",Object.defineProperty(t,"__esModule",{value:!0})}));