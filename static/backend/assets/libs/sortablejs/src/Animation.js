import{getRect,css,matrix,isRectEqual,indexOfObject}from"./utils.js";import Sortable from"./Sortable.js";export default function AnimationStateManager(){let t,e=[];return{captureAnimationState(){e=[],this.options.animation&&[].slice.call(this.el.children).forEach((t=>{if("none"===css(t,"display")||t===Sortable.ghost)return;e.push({target:t,rect:getRect(t)});let i={...e[e.length-1].rect};if(t.thisAnimationDuration){let e=matrix(t,!0);e&&(i.top-=e.f,i.left-=e.e)}t.fromRect=i}))},addAnimationState(t){e.push(t)},removeAnimationState(t){e.splice(indexOfObject(e,{target:t}),1)},animateAll(i){if(!this.options.animation)return clearTimeout(t),void("function"==typeof i&&i());let a=!1,n=0;e.forEach((t=>{let e=0,i=t.target,o=i.fromRect,r=getRect(i),s=i.prevFromRect,m=i.prevToRect,l=t.rect,c=matrix(i,!0);c&&(r.top-=c.f,r.left-=c.e),i.toRect=r,i.thisAnimationDuration&&isRectEqual(s,r)&&!isRectEqual(o,r)&&(l.top-r.top)/(l.left-r.left)==(o.top-r.top)/(o.left-r.left)&&(e=calculateRealTime(l,s,m,this.options)),isRectEqual(r,o)||(i.prevFromRect=o,i.prevToRect=r,e||(e=this.options.animation),this.animate(i,l,r,e)),e&&(a=!0,n=Math.max(n,e),clearTimeout(i.animationResetTimer),i.animationResetTimer=setTimeout((function(){i.animationTime=0,i.prevFromRect=null,i.fromRect=null,i.prevToRect=null,i.thisAnimationDuration=null}),e),i.thisAnimationDuration=e)})),clearTimeout(t),a?t=setTimeout((function(){"function"==typeof i&&i()}),n):"function"==typeof i&&i(),e=[]},animate(t,e,i,a){if(a){css(t,"transition",""),css(t,"transform","");let n=matrix(this.el),o=n&&n.a,r=n&&n.d,s=(e.left-i.left)/(o||1),m=(e.top-i.top)/(r||1);t.animatingX=!!s,t.animatingY=!!m,css(t,"transform","translate3d("+s+"px,"+m+"px,0)"),this.forRepaintDummy=repaint(t),css(t,"transition","transform "+a+"ms"+(this.options.easing?" "+this.options.easing:"")),css(t,"transform","translate3d(0,0,0)"),"number"==typeof t.animated&&clearTimeout(t.animated),t.animated=setTimeout((function(){css(t,"transition",""),css(t,"transform",""),t.animated=!1,t.animatingX=!1,t.animatingY=!1}),a)}}}}function repaint(t){return t.offsetWidth}function calculateRealTime(t,e,i,a){return Math.sqrt(Math.pow(e.top-t.top,2)+Math.pow(e.left-t.left,2))/Math.sqrt(Math.pow(e.top-i.top,2)+Math.pow(e.left-i.left,2))*a.animation}